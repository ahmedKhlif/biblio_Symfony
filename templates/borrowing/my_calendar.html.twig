{% extends 'backendofficebase.html.twig' %}

{% block title %}Mon calendrier d'emprunts{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css" rel="stylesheet">
<style>
    .personal-calendar {
        max-width: 100%;
        margin: 0 auto;
    }

    .calendar-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .status-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .status-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
    }

    .status-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 8px;
        display: inline-block;
    }

    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .upcoming-returns {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .return-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
    }

    .return-item:hover {
        background-color: #f8f9fa;
    }

    .return-item:last-child {
        border-bottom: none;
    }

    .return-book-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 15px;
    }

    .return-book-info {
        flex-grow: 1;
    }

    .return-book-title {
        font-weight: bold;
        margin-bottom: 2px;
    }

    .return-book-author {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .return-due-date {
        font-size: 0.9rem;
        color: #dc3545;
        font-weight: bold;
    }

    .return-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-overdue {
        background-color: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .empty-state .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block body %}
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-check text-primary mr-2"></i>Mon calendrier d'emprunts
        </h1>
        <p class="mb-0 text-muted">Suivez tous vos emprunts et retours</p>
    </div>
    <a href="{{ path('app_loan_index') }}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-list fa-sm text-white-50"></i> Voir la liste détaillée
    </a>
</div>

<!-- Stats Overview -->
<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-icon text-primary">
            <i class="fas fa-book-reader"></i>
        </div>
        <div class="stat-number text-primary">{{ app.user.getActiveLoans()|length }}</div>
        <div class="stat-label">Emprunts actifs</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number text-success">
            {{ app.user.loans|filter(loan => loan.status == 'returned')|length }}
        </div>
        <div class="stat-label">Livres retournés</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number text-warning">
            {{ app.user.loans|filter(loan => loan.status == 'requested' or loan.status == 'approved')|length }}
        </div>
        <div class="stat-label">En attente</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-danger">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-number text-danger">
            {{ app.user.loans|filter(loan => loan.status == 'overdue')|length }}
        </div>
        <div class="stat-label">En retard</div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <!-- Upcoming Returns -->
        <div class="upcoming-returns">
            <h5 class="mb-3">
                <i class="fas fa-calendar-times text-warning mr-2"></i>Prochains retours
            </h5>

            {% set upcomingReturns = app.user.loans|filter(loan => loan.status == 'active' and loan.dueDate)|sort((a, b) => a.dueDate <=> b.dueDate) %}

            {% if upcomingReturns %}
                {% for loan in upcomingReturns %}
                    <div class="return-item">
                        <img src="{{ loan.livre.image ? asset('uploads/images/' ~ loan.livre.image) : asset('img/undraw_profile.svg') }}"
                             alt="{{ loan.livre.titre }}" class="return-book-image">
                        <div class="return-book-info">
                            <div class="return-book-title">{{ loan.livre.titre }}</div>
                            <div class="return-book-author">{{ loan.livre.auteur.prenom }} {{ loan.livre.auteur.nom }}</div>
                            <div class="return-due-date">
                                <i class="fas fa-calendar mr-1"></i>
                                {{ loan.dueDate|date('d/m/Y') }}
                                {% if loan.getDaysRemaining() <= 1 %}
                                    <span class="text-danger">(Demain !)</span>
                                {% elseif loan.getDaysRemaining() < 0 %}
                                    <span class="text-danger">(En retard)</span>
                                {% else %}
                                    ({{ loan.getDaysRemaining() }} jours)
                                {% endif %}
                            </div>
                        </div>
                        <div class="return-status {{ loan.status == 'overdue' ? 'status-overdue' : 'status-active' }}">
                            {{ loan.getStatusLabel() }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h6>Aucun emprunt actif</h6>
                    <p class="mb-0">Vous n'avez pas d'emprunts en cours.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-8">
        <!-- Status Legend -->
        <div class="status-legend">
            <div class="status-item">
                <span class="status-color" style="background-color: #28a745;"></span>
                <span>En cours</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #dc3545;"></span>
                <span>En retard</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #6c757d;"></span>
                <span>Retourné</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #ffc107;"></span>
                <span>Demandé</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #17a2b8;"></span>
                <span>Approuvé</span>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div id="personal-calendar" class="personal-calendar"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/locales/fr.global.min.js"></script>

<script>
function initPersonalCalendar() {
    const calendarEl = document.getElementById('personal-calendar');
    
    // Verify element exists
    if (!calendarEl) {
        console.error('Calendar element not found');
        return;
    }
    
    // Clear any existing calendar
    calendarEl.innerHTML = '';
    
    // Parse events safely
    let events = [];
    try {
        const rawEvents = {{ events|raw }};
        events = Array.isArray(rawEvents) ? rawEvents : [];
        console.log('Calendar events loaded:', events);
    } catch (error) {
        console.error('Error parsing calendar events:', error);
        events = [];
    }

    // Check if FullCalendar is available (wait with delay if needed)
    const checkCalendar = setInterval(function() {
        if (typeof FullCalendar !== 'undefined') {
            clearInterval(checkCalendar);
            renderCalendar();
        }
    }, 100);

    // Timeout after 5 seconds
    setTimeout(function() {
        clearInterval(checkCalendar);
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar library failed to load');
        }
    }, 5000);

    function renderCalendar() {
        try {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                events: events,
                eventDisplay: 'block',
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                dayMaxEvents: true,
                moreLinkClick: 'popover',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                buttonText: {
                    today: 'Aujourd\'hui',
                    month: 'Mois',
                    week: 'Semaine'
                },
                eventClick: function(info) {
                    // Open book details in new tab
                    if (info.event.url) {
                        window.open(info.event.url, '_blank');
                    }
                    info.jsEvent.preventDefault();
                },
                eventDidMount: function(info) {
                    // Add tooltip with book title
                    info.el.setAttribute('title', info.event.title);
                },
                datesSet: function(info) {
                    console.log('Calendar rendered for period:', info.start, 'to', info.end);
                }
            });

            calendar.render();
            console.log('Calendar initialized successfully');
        } catch (error) {
            console.error('Error initializing calendar:', error);
        }
    }

    // If FullCalendar is already loaded, initialize immediately
    if (typeof FullCalendar !== 'undefined') {
        renderCalendar();
    }
}

// Support both regular page load and Turbo navigation
document.addEventListener('DOMContentLoaded', initPersonalCalendar);
document.addEventListener('turbo:load', initPersonalCalendar);
document.addEventListener('turbo:render', initPersonalCalendar);
</script>
{% endblock %}