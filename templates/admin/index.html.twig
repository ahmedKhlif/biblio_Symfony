{% extends '@EasyAdmin/page/content.html.twig' %}

{% block page_title 'Tableau de Bord Administrateur - Bibliothèque' %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-tachometer-alt fa-sm text-primary mr-2"></i>
                Tableau de Bord Administrateur
            </h1>
            <p class="mb-0 text-muted">Vue d'ensemble complète du système de gestion de bibliothèque</p>
        </div>
        <div>
            <a href="{{ path('app_backoffice_dashboard') }}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm mr-2">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Interface Utilisateur
            </a>
            <a href="{{ ea_url().setController('App\\Controller\\Admin\\ActivityLogCrudController').setAction('index') }}" class="d-none d-sm-inline-block btn btn-sm btn-info shadow-sm">
                <i class="fas fa-history fa-sm text-white-50"></i> Logs d'Activité
            </a>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <!-- Livres Count -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Livres</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ livreCount }}</div>
                            <div class="text-xs text-muted">{{ totalStock }} exemplaires</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Count -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Commandes</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ orderCount }}</div>
                            <div class="text-xs text-muted">{{ pendingOrders }} en attente</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-bag fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Revenus</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalRevenue|number_format(0, ',', ' ') }}€</div>
                            <div class="text-xs text-muted">{{ shippedOrders }} expédiées</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-euro-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emprunts Count -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Emprunts</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ loanCount }}</div>
                            <div class="text-xs text-muted">
                                {% if requestedLoans > 0 %}
                                    <span class="badge badge-danger">{{ requestedLoans }} en attente</span>
                                {% endif %}
                                {{ activeLoans }} actifs
                                {% if overdueLoans > 0 %}
                                    , <span class="text-danger">{{ overdueLoans }} en retard</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book-reader fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Avis Count -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Avis</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ reviewCount }}</div>
                            <div class="text-xs text-muted">Note moyenne: {{ avgRating|number_format(1, ',', ' ') }}/5</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-star fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utilisateurs Count -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Utilisateurs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ userCount }}</div>
                            <div class="text-xs text-muted">{{ activeUsers }} actifs, {{ adminUsers }} admins</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Status Alert -->
    {% if outOfStockCount > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Attention:</strong> {{ outOfStockCount }} livre{{ outOfStockCount > 1 ? 's' : '' }} {{ outOfStockCount > 1 ? 'sont' : 'est' }} en rupture de stock.
                <a href="{{ ea_url().setController('App\\Controller\\Admin\\LivreCrudController').setAction('index') }}" class="alert-link">Voir la liste</a>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Category Distribution Chart -->
        <div class="col-xl-6 col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Répartition par Catégorie
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        <canvas id="categoryChart" style="display: block;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Activity Chart -->
        <div class="col-xl-6 col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-chart-line mr-2"></i>
                        Activité Mensuelle (12 derniers mois)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        <canvas id="activityChart" style="display: block;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Activity & Books -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <!-- Recent Activity -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history mr-2"></i>
                        Activité Récente
                    </h6>
                    <a href="{{ ea_url().setController('App\\Controller\\Admin\\ActivityLogCrudController').setAction('index') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye mr-1"></i>Voir tout
                    </a>
                </div>
                <div class="card-body">
                    {% if recentActivity is empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-history fa-3x text-gray-300 mb-3"></i>
                            <p class="text-muted">Aucune activité récente</p>
                        </div>
                    {% else %}
                        <div class="timeline">
                            {% for activity in recentActivity %}
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">
                                            <strong>{{ activity.user ? activity.user.username ?: activity.user.email : 'Système' }}</strong>
                                            {{ activity.action }}
                                        </h6>
                                        <p class="timeline-text text-muted mb-1">{{ activity.description ?: 'Aucune description' }}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock mr-1"></i>{{ activity.createdAt ? activity.createdAt|date('d/m/Y H:i') : 'N/A' }}
                                            {% if activity.ipAddress %}
                                                • IP: {{ activity.ipAddress }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Loan Approvals Alert -->
            {% if requestedLoans > 0 %}
            <div class="card shadow mb-4 border-left-danger">
                <div class="card-header py-3 bg-danger d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-hourglass-end mr-2"></i>
                        Emprunts en Attente d'Approbation ({{ requestedLoans }})
                    </h6>
                    <a href="{{ ea_url().setController('App\\Controller\\Admin\\LoanCrudController').setAction('index') }}" class="btn btn-sm btn-light">
                        <i class="fas fa-eye mr-1"></i>Voir tout
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-exclamation-circle mr-2 text-danger"></i>
                        Il y a <strong class="text-danger">{{ requestedLoans }}</strong> demande{{ requestedLoans > 1 ? 's' : '' }} d'emprunt en attente d'approbation.
                    </p>
                    <a href="{{ ea_url().setController('App\\Controller\\Admin\\LoanCrudController').setAction('index') }}" class="btn btn-danger btn-sm btn-block">
                        <i class="fas fa-check-circle mr-2"></i>Gérer les Emprunts
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Recent Books -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-book mr-2"></i>
                        Livres Récemment Ajoutés
                    </h6>
                    <a href="{{ ea_url().setController('App\\Controller\\Admin\\LivreCrudController').setAction('index') }}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-eye mr-1"></i>Voir tous
                    </a>
                </div>
                <div class="card-body">
                    {% if recentLivres is empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-book-open fa-3x text-gray-300 mb-3"></i>
                            <p class="text-muted">Aucun livre récent trouvé</p>
                        </div>
                    {% else %}
                        <div class="row">
                            {% for livre in recentLivres %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-left-primary h-100">
                                        <div class="card-body py-3">
                                            <div class="row align-items-center">
                                                <div class="col-auto">
                                                    {% if livre.image %}
                                                        <img src="{{ asset('uploads/images/' ~ livre.image) }}"
                                                             alt="{{ livre.titre }}"
                                                             class="rounded"
                                                             style="width: 50px; height: 70px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                                             style="width: 50px; height: 70px;">
                                                            <i class="fas fa-book text-muted"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col">
                                                    <h6 class="font-weight-bold mb-1">{{ livre.titre|slice(0, 25) ~ (livre.titre|length > 25 ? '...' : '') }}</h6>
                                                    <p class="text-muted small mb-1">
                                                        {{ livre.auteur ? livre.auteur.prenom ~ ' ' ~ livre.auteur.nom : 'Auteur inconnu' }}
                                                    </p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge badge-primary">{{ livre.prix }}€</span>
                                                        <small class="text-muted">{{ livre.createdAt ? livre.createdAt|date('d/m/Y') : 'N/A' }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt mr-2"></i>
                        Actions Rapides
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\LivreCrudController').setAction('new') }}"
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-plus mr-2"></i>Ajouter un Livre
                        </a>
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\AuteurCrudController').setAction('new') }}"
                           class="btn btn-success btn-sm">
                            <i class="fas fa-user-plus mr-2"></i>Ajouter un Auteur
                        </a>
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\CategorieCrudController').setAction('new') }}"
                           class="btn btn-info btn-sm">
                            <i class="fas fa-tag mr-2"></i>Ajouter une Catégorie
                        </a>
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\EditeurCrudController').setAction('new') }}"
                           class="btn btn-warning btn-sm">
                            <i class="fas fa-building mr-2"></i>Ajouter un Éditeur
                        </a>
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\UserCrudController').setAction('new') }}"
                           class="btn btn-danger btn-sm">
                            <i class="fas fa-user-plus mr-2"></i>Ajouter un Utilisateur
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Users -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-users mr-2"></i>
                        Utilisateurs Récents
                    </h6>
                </div>
                <div class="card-body">
                    {% if recentUsers is empty %}
                        <div class="text-center py-3">
                            <i class="fas fa-users fa-2x text-gray-300 mb-2"></i>
                            <p class="text-muted small">Aucun utilisateur récent</p>
                        </div>
                    {% else %}
                        <div class="list-group list-group-flush">
                            {% for user in recentUsers %}
                                <div class="list-group-item px-0 py-2">
                                    <div class="d-flex align-items-center">
                                        <div class="mr-3">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0 font-weight-bold">{{ user.username ?: user.email }}</h6>
                                            <small class="text-muted">
                                                {% if user.roles %}
                                                    {% for role in user.roles %}
                                                        {% if role starts with 'ROLE_' %}
                                                            {{ role|replace({'ROLE_': ''}) }}
                                                            {% if not loop.last %}, {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    Utilisateur
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="text-right">
                                            <small class="text-muted">{{ user.createdAt ? user.createdAt|date('d/m') : 'N/A' }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- System Health -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-heartbeat mr-2"></i>
                        État du Système
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Stock Status</span>
                            <span class="badge badge-{{ outOfStockCount == 0 ? 'success' : 'warning' }}">
                                {{ outOfStockCount == 0 ? 'Optimal' : outOfStockCount ~ ' en rupture' }}
                            </span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-{{ outOfStockCount == 0 ? 'success' : 'warning' }}"
                                 style="width: {{ (livreCount - outOfStockCount) / livreCount * 100 }}%"></div>
                        </div>
                    </div>

                    <hr>

                    <div class="small text-muted mb-2">
                        <i class="fas fa-server mr-1"></i>
                        Symfony {{ constant('Symfony\\Component\\HttpKernel\\Kernel::VERSION') }}
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="fas fa-database mr-1"></i>
                        Doctrine ORM
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="fas fa-shield-alt mr-1"></i>
                        EasyAdmin v4.27
                    </div>
                    <div class="small text-muted">
                        <i class="fas fa-clock mr-1"></i>
                        {{ 'now'|date('d/m/Y H:i') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js and initialization INSIDE content block -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    // Chart data from Twig
    var categoryLabels = {{ categoryStats|column('designation')|json_encode|raw }};
    var categoryData = {{ categoryStats|column('livreCount')|json_encode|raw }};
    var activityLabels = {{ monthlyActivity|column('month')|json_encode|raw }};
    var activityData = {{ monthlyActivity|column('count')|json_encode|raw }};
    
    function initCharts() {
        // Destroy existing charts
        if (window.catChart) { window.catChart.destroy(); }
        if (window.actChart) { window.actChart.destroy(); }
        
        // Category Chart
        var catCanvas = document.getElementById('categoryChart');
        if (catCanvas) {
            window.catChart = new Chart(catCanvas, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#2e59d9', '#17a2b8'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#5a5c69' } } }
                }
            });
        }
        
        // Activity Chart
        var actCanvas = document.getElementById('activityChart');
        if (actCanvas) {
            window.actChart = new Chart(actCanvas, {
                type: 'line',
                data: {
                    labels: activityLabels,
                    datasets: [{
                        label: 'Activité',
                        data: activityData,
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#5a5c69' } },
                        x: { ticks: { color: '#5a5c69' } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: '#5a5c69' } } }
                }
            });
        }
    }
    
    // Run immediately
    if (typeof Chart !== 'undefined') {
        initCharts();
    } else {
        // Wait for Chart.js to load
        var checkChart = setInterval(function() {
            if (typeof Chart !== 'undefined') {
                clearInterval(checkChart);
                initCharts();
            }
        }, 100);
    }
    
    // Support Turbo navigation
    document.addEventListener('turbo:load', initCharts);
    document.addEventListener('turbo:render', initCharts);
})();
</script>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
.card {
    border: none;
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
}

.card-header {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    border-bottom: none;
    border-radius: 0.35rem 0.35rem 0 0 !important;
}

.btn {
    border-radius: 0.35rem;
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.5rem 0 rgba(58, 59, 69, 0.2);
}

.badge {
    border-radius: 0.35rem;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #e3e6f0;
    transition: background-color 0.2s ease-in-out;
}

.list-group-item:hover {
    background-color: #f8f9fc;
}

.list-group-item:last-child {
    border-bottom: none;
}

/* Timeline Styles */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e9ecef;
}

.timeline-content {
    background: white;
    padding: 15px;
    border-radius: 0.35rem;
    border: 1px solid #e9ecef;
}

.timeline-title {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.timeline-text {
    font-size: 0.85rem;
}

/* Chart containers */
.chart-container {
    position: relative;
    margin: auto;
    height: 300px;
    width: 100%;
    background-color: #fff;
}

/* Force card backgrounds to white for charts */
.card {
    background-color: #fff !important;
}

.card-body {
    background-color: #fff !important;
}

.card-header {
    background-color: #f8f9fc !important;
}

/* Alert improvements */
.alert {
    border-radius: 0.35rem;
    border: none;
}

/* Progress bars */
.progress {
    border-radius: 10px;
    background-color: #eaecf4;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .timeline {
        padding-left: 20px;
    }

    .timeline-marker {
        left: -17px;
        width: 10px;
        height: 10px;
    }

    .chart-container {
        height: 250px;
    }
}
</style>
{% endblock %}