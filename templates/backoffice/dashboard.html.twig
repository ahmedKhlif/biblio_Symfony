{% extends 'base.html.twig' %}

{% block title %}Dashboard - Biblio Admin{% endblock %}

{% block body %}
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Total Books Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Livres</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ livres|length }}</div>
                            <div class="text-xs text-muted">Livres en stock</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Authors Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Auteurs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ auteurs|length }}</div>
                            <div class="text-xs text-muted">Auteurs enregistrés</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Categories Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Catégories</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ categories|length }}</div>
                            <div class="text-xs text-muted">Catégories disponibles</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tags fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Publishers Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Éditeurs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ editeurs|length }}</div>
                            <div class="text-xs text-muted">Éditeurs partenaires</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->

    <div class="row">

        <!-- Bar Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition par Entité</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Actions:</div>
                            <a class="dropdown-item" href="#">Actualiser</a>
                            <a class="dropdown-item" href="#">Exporter</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Paramètres</a>
                        </div>
                    </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="myBarChart"></canvas>
                    </div>
                </div>
                <script>
                    // Bar Chart
                    var ctx = document.getElementById("myBarChart");
                    var myBarChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ["Livres", "Auteurs", "Catégories", "Éditeurs"],
                            datasets: [{
                                label: "Nombre",
                                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                                hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#f4b619'],
                                borderColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                                data: [{{ livres|length }}, {{ auteurs|length }}, {{ categories|length }}, {{ editeurs|length }}],
                            }],
                        },
                        options: {
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 10,
                                    right: 25,
                                    top: 25,
                                    bottom: 0
                                }
                            },
                            scales: {
                                xAxes: [{
                                    gridLines: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxTicksLimit: 6
                                    },
                                    maxBarThickness: 25,
                                }],
                                yAxes: [{
                                    ticks: {
                                        min: 0,
                                        max: Math.max({{ livres|length }}, {{ auteurs|length }}, {{ categories|length }}, {{ editeurs|length }}) + 2,
                                        maxTicksLimit: 5,
                                        padding: 10,
                                    },
                                    gridLines: {
                                        color: "rgb(234, 236, 244)",
                                        zeroLineColor: "rgb(234, 236, 244)",
                                        drawBorder: false,
                                        borderDash: [2],
                                        zeroLineBorderDash: [2]
                                    }
                                }],
                            },
                            legend: {
                                display: false
                            },
                            tooltips: {
                                titleMarginBottom: 10,
                                titleFontColor: '#6c757d',
                                titleFontSize: 14,
                                backgroundColor: "rgb(255,255,255)",
                                bodyFontColor: "#858796",
                                borderColor: '#dddfeb',
                                borderWidth: 1,
                                xPadding: 15,
                                yPadding: 15,
                                displayColors: false,
                                caretPadding: 10,
                            },
                        }
                    });
                </script>
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition par Catégorie</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Dropdown Header:</div>
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        {% for item in chartData %}
                            <span class="mr-2">
                                <i class="fas fa-circle text-primary"></i> {{ item.label }} ({{ item.count }})
                            </span>
                        {% endfor %}
                    </div>
                </div>
                <script>
                    // Pie Chart
                    var ctx = document.getElementById("myPieChart");
                    var myPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: {{ chartData|map(c => c.label)|json_encode|raw }},
                            datasets: [{
                                data: {{ chartData|map(c => c.count)|json_encode|raw }},
                                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                                hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02d1b', '#6c757d'],
                                hoverBorderColor: "rgba(234, 236, 244, 1)",
                            }],
                        },
                        options: {
                            maintainAspectRatio: false,
                            tooltips: {
                                backgroundColor: "rgb(255,255,255)",
                                bodyFontColor: "#858796",
                                borderColor: '#dddfeb',
                                borderWidth: 1,
                                xPadding: 15,
                                yPadding: 15,
                                displayColors: false,
                                caretPadding: 10,
                            },
                            legend: {
                                display: false
                            },
                            cutoutPercentage: 80,
                        },
                    });
                </script>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Content Column -->
        <div class="col-lg-6 mb-4">

            <!-- Recent Activity -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Activité Récente</h6>
                </div>
                <div class="card-body">
                    {% for livre in derniersLivres %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1">
                                <h6 class="font-weight-bold mb-1">
                                    <i class="fas fa-book text-primary mr-2"></i>{{ livre.titre }}
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-user text-success mr-1"></i>{{ livre.auteur ? livre.auteur.prenom ~ ' ' ~ livre.auteur.nom : 'Auteur inconnu' }} •
                                    <i class="fas fa-tag text-info mr-1"></i>{{ livre.categorie ? livre.categorie.designation : 'N/A' }} •
                                    <i class="fas fa-euro-sign text-warning mr-1"></i>{{ livre.prix|number_format(2, ',', ' ') }} €
                                </small>
                            </div>
                            <div class="text-right">
                                <small class="text-muted">
                                    <i class="fas fa-calendar text-secondary mr-1"></i>{{ livre.dateEdition|date('d/m/Y') }}
                                </small>
                            </div>
                        </div>
                        {% if not loop.last %}<hr class="my-2">{% endif %}
                    {% else %}
                        <p class="text-muted">
                            <i class="fas fa-info-circle text-info mr-2"></i>Aucune activité récente trouvée.
                        </p>
                    {% endfor %}
                </div>
            </div>

            <!-- Library Insights -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Aperçus de la Bibliothèque</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <i class="fas fa-chart-pie fa-2x text-primary mb-2"></i>
                                <h6 class="text-primary">{{ categories|length }}</h6>
                                <small class="text-muted">Catégories actives</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center mb-3">
                                <i class="fas fa-building fa-2x text-success mb-2"></i>
                                <h6 class="text-success">{{ editeurs|length }}</h6>
                                <small class="text-muted">Éditeurs partenaires</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb text-warning mr-1"></i>
                            Bibliothèque diversifiée avec {{ livres|length }} titres uniques
                        </small>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-6 mb-4">

            <!-- Library Activity -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Activité de la Bibliothèque</h6>
                </div>
                <div class="card-body">
                    {% set totalExemplaires = 0 %}
                    {% set totalValeur = 0 %}
                    {% for livre in livres %}
                        {% set totalExemplaires = totalExemplaires + livre.nbExemplaires %}
                        {% set totalValeur = totalValeur + (livre.prix * livre.nbExemplaires) %}
                    {% endfor %}

                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-primary">{{ totalExemplaires }}</h4>
                                <small class="text-muted">Exemplaires physiques</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success">{{ totalValeur|number_format(0, ',', ' ') }}€</h4>
                                <small class="text-muted">Valeur totale</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-info">{{ livres|length }}</h6>
                                <small class="text-muted">Titres uniques</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-warning">{{ auteurs|length }}</h6>
                                <small class="text-muted">Auteurs représentés</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">État du Système</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-database fa-2x text-success mb-2"></i>
                                <h6 class="text-success">Base de données</h6>
                                <small class="text-muted">Opérationnelle</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-server fa-2x text-primary mb-2"></i>
                                <h6 class="text-primary">Serveur</h6>
                                <small class="text-muted">En ligne</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">Dernière mise à jour: {{ "now"|date("d/m/Y H:i") }}</small>
                    </div>
                </div>
            </div>

        </div>
    </div>
{% endblock %}